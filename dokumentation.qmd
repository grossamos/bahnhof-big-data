---
title: "Bahnhof"
author: "Edmund Krain und Amos Gross"
date: "08.01.2023"
editor: visual
format: 
  html:
    fig-width: 8
    fig-height: 4
---

## Fragestellung

### Datenquellen

<!-- https://www.deutschebahn.com/pr-hamburg-de/DB-im-Norden-1/Regionale-Themen/Bahnhoefe-der-Deutschen-Bahn-6121238 -->

<!-- ->haben alle bahnhöfe in de (sind 5400) -->

## Laden der Daten

Import der Bibliotheken:
```{r}
#| warning: false
#| output: false

library(tidyverse)
library(ggmap)
library(broom)
library(sf)
library(cowplot)
```

### bahnhof.csv Daten laden:
```{r}
# plz als char um start mit 0 besser zu erkennen
bahnhof <- read_delim("./data/bahnhof.csv", delim = ";", col_types = "cccdccdcccc")
# sapply(bahnhof, function(x) (sum(is.na(x))))
# length(unique(bahnhof$`Bf. Nr.`)) == nrow(bahnhof)
bahnhof[bahnhof$`Bf. Nr.` == "8268", c("PLZ", "Ort")] <- list("60549", "Frankfurt")
bahnhof[bahnhof$`Bf. Nr.` == "8353", c("Straße", "PLZ", "Ort")] <- list("Vareler Straße", "26349", "Jaderberg")
bahnhof[bahnhof$`Bf. Nr.` == "8256", c("Straße", "PLZ", "Ort")] <- list("Oberaustraße", "83026", "Rosenheim")
bahnhof[bahnhof$`Bf. Nr.` == "8298", c("Straße", "PLZ", "Ort")] <- list("Schlosswald 20z", "09114", "Chemnitz")
bahnhof[bahnhof$`Bf. Nr.` == "8276", c("Straße", "PLZ", "Ort")] <- list("Mockauer Straße 123", "04357", "Leipzig")
bahnhof[bahnhof$`Bf. Nr.` == "8233", c("Straße", "PLZ", "Ort")] <- list("Am Stadtrand", "06406", "Bernburg")
bahnhof[bahnhof$`Bf. Nr.` == "8288", c("Straße", "PLZ", "Ort", "Bf DS 100Abk.")] <- list("Mühlenweg 4", "48734", "Reken", "EREK")
bahnhof[bahnhof$`Bf. Nr.` == "8314", "Straße"] <- "Zweibrückenstraße 13"
bahnhof[bahnhof$`Bf. Nr.` == "5827", "Straße"] <- "Feldkirchener Straße"
bahnhof$PLZ[nchar(bahnhof$PLZ) == 4] <- paste("0", bahnhof$PLZ[nchar(bahnhof$PLZ) == 4], sep = "")

bahnhof <- bahnhof %>%
  mutate_at(vars(`Kat. Vst`), factor)

```

### locations.csv Daten laden

geocode() verwendet um aus Adressen Geokoordinaten zu erhalten
```{r}
#| output: false

# Code um geolocation von bahnhöfen zu kriegen
# locations <- geocode(paste(bahnhof$Straße, bahnhof$Ort, sep = " "))
# write_csv(locations, "data/locations.csv")

stations_geo_loc <- read_csv("data/locations.csv", show_col_types = FALSE)

# filter out invalid locations (outside of Germany) and trainstations gmaps couldn't find
stations_geo_loc <- stations_geo_loc[!stations_geo_loc$bahnhof_index %in% c(4651,654,1937,2794,2807,3080,184,4851,559,3622,2703,2305,3494,3160,3084), ]
previous_len <- nrow(stations_geo_loc)
stations_geo_loc <- stations_geo_loc %>%
  filter(!is.na(lat) & !is.na(lon) & lon > 0)
 nrow(stations_geo_loc) / previous_len # we have presumably correct geolocations of 98% of the provided rows
stations_geo_loc <- left_join(stations_geo_loc, rowid_to_column(bahnhof, "bahnhof_index"), by = c("bahnhof_index" = "bahnhof_index"))

```

### Kartenmaterial inclusive Einwohner und Fläche
```{r}
#| output: false

german_states <- st_read(dsn = "data/german_states/")
german_states$name_1[german_states$id_1 == "1"] <- "Baden-Württemberg"
german_states$name_1[german_states$id_1 == "16"] <- "Thüringen"
german_states$population <- c(
  11124642,
  13176989,
  3677472,
  2537868,
  676463,
  1853935,
  6295017,
  1611160,
  8027031,
  17924591,
  4106485,
  982348,
  4043002,
  2169253,
  2922005,
  2108863
)

german_states$area <- c(
  35747.83,
  70541.57,
  891.12,
  29654.43,
  419.37,
  755.09,
  21115.64,
  23295.22,
  47709.80,
  34112.44,
  19858,
  2571.11,
  18449.93,
  20456.51,
  15800.54,
  16202.35
)
```



## Geographische Analyse


Alle Bahnhöfe als Punkte auf einer Karte:

todo: 
* Aufgabenträger je Bahnhof (pointcloud)
* karte mit farbe je kategorie
```{r}
ggplot() + 
  geom_sf(data = german_states) +
  geom_point(
    stations_geo_loc, 
    mapping = aes(x = lon, y = lat, color = Aufgabenträger),
    size = 0.1,
    show.legend = F
  ) 
ggplot() + 
  geom_sf(data = german_states) +
  geom_point(
    stations_geo_loc, 
    mapping = aes(x = lon, y = lat, color = `Kat. Vst`),
    size = 0.1,
  ) +
  scale_color_manual(values = c(
    "black", # Fernbahnof (Hbf)
    "blue", # Hbf größerer Städte
    "green", # Hbf kleiner/mittleren städten
    "yellow", # regionalbahnhof
    "red", # stadtteilbahnhof
    "orange", # landbahnof
    "pink" # ultra landbahnhof
  ))
```

Vergleich auf Bundesländerebene:
```{r}
german_states_weighted <- left_join(
  german_states, 
  bahnhof %>% 
    count(Bundesland),
  by = c("name_1" = "Bundesland")
)


# Heatmap of station density
p1 <- ggplot(data = german_states_weighted) + 
  geom_sf(
    aes(fill = population/n)
  ) +
  theme(legend.position = "bottom")

p2 <- ggplot(data = german_states_weighted) + 
  geom_sf(
    aes(fill = population/area)
  ) +
  theme(legend.position = "bottom")

p3 <- ggplot(data = german_states_weighted) + 
  geom_sf(
    aes(fill = n/area)
  ) +
  theme(legend.position = "bottom")

plot_grid(p2, p3, p1, nrow = 1)
```

### erste 2 ziffern plz (todo)


### Mehr Granularität durch Postleitzahlen:

Datentransformation:
```{r}
#| output: false

german_plz <- st_read("./data/german_plz")

german_plz_weighted <- left_join(
  german_plz,
  bahnhof %>%
    count(PLZ) %>%
    replace_na(list(n = 0)),
  by = c("plz" = "PLZ")
)

german_plz_weighted <- german_plz_weighted %>%
  mutate(
    ratio1 = einwohner/n,
    ratio2 = einwohner/qkm,
    ratio3 = n/qkm,
  ) %>%
  replace_na(list(n = 0, ratio1 = 0, ratio2 = 0, ratio3 = 0))

# TODO (obersten 2 sind flughäfen)
# german_plz_weighted %>% arrange((ratio2))
```

Plotting:
```{r}
#| warning: false

# wir sehen wesentlich breiteren ausbau im osten (mehr plz haben bahnhöfe)
p1 <- ggplot(data = german_plz_weighted) +
  geom_sf(
    aes(fill = ratio1), 
    linewidth = 0.01
  ) +
  scale_fill_gradient(name = "Bevölkerung pro Bahnhof", trans = "log") +
  theme(legend.position = "bottom")

p2 <- ggplot(data = german_plz_weighted) +
  geom_sf(
    aes(fill = ratio2), 
    linewidth = 0.01
  ) +
  scale_fill_gradient(name = "Bevölkerungsdichte", trans = "log") +
  theme(legend.position = "bottom")

p3 <- ggplot(data = german_plz_weighted) +
  geom_sf(
    aes(fill = ratio3), 
    linewidth = 0.01
  ) +
  scale_fill_gradient(name = "Bahnhofsdichte", trans = "log") +
  theme(legend.position = "bottom")

plot_grid(p2, p3, p1, nrow = 1)
```



## Normale Diagramme


### Boxplot 
im vergleich zu oben
```{r}

ggplot(german_plz_weighted %>% group_by(n) %>% filter(n() >= 25)) +
  geom_boxplot(aes(x = n, y = einwohner, fill = n, group = n))

# ggplot(german_plz_weighted %>% group_by(n) %>% filter(n() >= 25)) +
#   geom_violin(aes(x = n, y = einwohner, fill = n, group = n))
```


### Fun fact

dieser Prozentsatz an Bahnhöfen ist in einer Bahnhofstraße, Bahnhofallee, etc.
```{r}
bahnhof %>%
  filter(grepl("Bahnhof", Straße)) %>%
  count(.) / nrow(bahnhof)
```

todo: 
* top 10 städte nach anzahl bahnhöfe (barchart) (zusätzlich aufteilung in kategorien)



<!-- Stadt Land -->

<!-- Ost West -->

## Fazit

Erkenntnisse aus Daten:
* Viele Lücken in Bahnhofskarte
* (Bahnhofmenge korreliert leicht mit Einwohneranzahl)
* ....


## Quellen

